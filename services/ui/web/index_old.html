<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Auto Pot-Purri</title>
    <script src="./js/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="./js/d3.v5.min.js" charset="utf-8"></script>

    <link rel="stylesheet" type="text/css" href="./styles.css">
</head>

<body>

    <div id="chart"></div>

    <script>
        /*
         *  Returns a chart
         */
        function createChart(canvasWidth, canvasHeight, margin = {
            top: 0,
            right: 0,
            bottom: 0,
            left: 0
        }) {

            var chart = d3.select("#chart")
                .append("svg")
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + canvasWidth + " " + canvasHeight)
                .attr("width", canvasWidth)
                .attr("height", canvasHeight)
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .append("g")
                .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")

            return chart

        }

        /*
         *  Returns the x-scale as time scale
         */
        function getXScale(startTime, endTime, width) {

            var minDate = d3.isoParse(startTime)
            var maxDate = d3.isoParse(endTime)

            var xScale = d3.scaleTime()
                .domain([minDate, maxDate])
                .range([0, width])

            return xScale
        }

        /*
         *  Returns the y-scale as linear (for percentage values)
         */
        function getYScale(height) {

            var yScale = d3.scaleLinear()
                .domain([1, 0])
                .range([0, height])

            return yScale
        }

        /*
         *  Applies basic setup to the given chart
         */
        function setupChart(chart, xScale, yScale, width, time_interval_in_microseconds = 1000 * 60 * 60 * 24) {

            /* setup y axis */

            chart.append("g")
                .call(
                    d3.axisLeft(yScale)
                    .ticks(10)
                    .tickFormat(d3.format(".0%"))
                )
                .classed("axis axis-y axis-time", true)


            /* setup x axis */

            chart.append("g")
                .attr("transform", "translate(0, " + height + ")")
                .call(
                    d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat("%H:%M"))
                )
                .classed("axis axis-x axis-percentage", true)


            /* define grid */

            // horizontal 10 % lines:

            for (var i = 10; i <= 100; i += 10) {

                var group = chart.append("g")
                    .classed("ten-percent-line", true)
                group.append("line")
                    .attr("x1", 0)
                    .attr("y1", yScale(i / 100))
                    .attr("x2", width)
                    .attr("y2", yScale(i / 100))
            }

            // vertical midnight lines:
            var midnights = getMidnightsInInterval(startTime, endTime)

            midnights.forEach((timestamp) => {
                var group = chart.append("g")
                    .classed("midnight-line", true)
                group.append("line")
                    .attr("x1", xScale(timestamp))
                    .attr("y1", height)
                    .attr("x2", xScale(timestamp))
                    .attr("y2", 0)
                group.append("text")
                    .text(timestamp.toLocaleDateString())
                    .attr("x", xScale(timestamp) + 4)
                    .attr("y", yScale(0.98))
            })

        }

        /*
         *  Updates data in a given chart
         */
        function updateData(chart, xScale, yScale, startTime, endTime) {

            getSamplesAsync(startTime.toISOString(), endTime.toISOString(), function (data) {

                // re-format data points
                for (var i = 0; i < data.length; i++) {
                    data[i].timestamp = d3.isoParse(data[i].timestamp)
                    data[i].value_percent = (1024 - data[i].value_raw) * (1 / 1024)
                }

                // re-arrange data to create one line per sensor
                var data = d3.nest()
                    .key(function (d) {
                        return d.device_id
                    })
                    .entries(data)


                // add attributes to each dataset
                for (var i = 0; i < data.length; i++) {
                    data[i].color = d3.schemeSet1[i]
                }


                // Define data lines:
                var dataLine = d3.line()
                    .x(function (d) {
                        return xScale(d.timestamp)
                    })
                    .y(function (d) {
                        return yScale(d.value_percent)
                    })

                // Add lines to chart:
                data.forEach(function (d) {

                    // path
                    chart.append("path")
                        .attr("d", dataLine(d.values))
                        .attr("stroke", d.color)
                        .classed("line", true)

                    // label
                    chart.append("text")
                        .attr("transform", "translate(" + (width + 5) + ", " + yScale(d.values[
                            d.values
                            .length -
                            1].value_percent) + ")")
                        .attr("fill", d.color)
                        .text(d.values[0].device_id + "." + d.values[0].sensor_id)
                        .classed("label", true)
                })

            })

        }

        /*
         *  Queries data from the datastore and returns
         *  it as an JSON object
         */
        function getSamplesAsync(startTime, endTime, callback) {

            $.get("http://" + document.location.hostname + ":" + document.location.port + "/datastore", function (
                result) {

                var datastore_hostname = result.data.datastore.hostname
                var datastore_port = result.data.datastore.port

                var url =
                    "http://" + datastore_hostname + ":" + datastore_port + "/api/v1/samples?timestampStart=" +
                    startTime +
                    "&timestampEnd=2" + endTime

                $.get(url, function (result) {
                    callback(result.data)
                })

            })
        }


        /**
         *  Returns an array of timestamps of all midnights between
         *  startTime and endTime.
         */
        function getMidnightsInInterval(startTime, endTime) {

            var time = startTime
            var midnights = new Array()
            while (true) {

                time = new Date(
                    time.getFullYear(),
                    time.getMonth(),
                    time.getDate() + 1
                )

                if (time < endTime) {
                    midnights.push(time)
                } else {
                    break
                }

            }

            return midnights

        }
    </script>

    <script>
        // -- CONFIG

        /* set time interval */

        // var time_interval_in_microseconds = 1000 * 60 * 60 * 72 // 72 h
        var time_interval_in_microseconds = 1000 * 60 * 60 * 48 // 48 h
        // var time_interval_in_microseconds = 1000 * 60 * 60 * 24 // 24 h
        // var time_interval_in_microseconds = 1000 * 60 * 60 * 12 // 12 h
        // var time_interval_in_microseconds = 1000 * 60 * 60 * 6 // 6 h
        // var time_interval_in_microseconds = 1000 * 60 * 60 * 1 // 6 h


        /* define dimensions and margin according to d3 conventions */

        var canvasWidth = document.getElementById("chart").clientWidth
        var canvasHeight = canvasWidth * 2 / 3

        var margin = {
            top: 20,
            right: 50,
            bottom: 30,
            left: 50
        }
        var width = canvasWidth - margin.left - margin.right
        var height = canvasHeight - margin.top - margin.bottom


        // -- MAIN

        var date = new Date()
        var startTime = new Date(date.getTime() - time_interval_in_microseconds)
        var endTime = new Date(date.getTime())

        var chart = createChart(canvasWidth, canvasHeight, margin)

        setupChart(chart, getXScale(startTime, endTime, width), getYScale(height), width, time_interval_in_microseconds)
        updateData(chart, getXScale(startTime, endTime, width), getYScale(height), startTime, endTime)
        // setInterval(updateData, 1000, chart)
    </script>

    <div class="chart-legend">
        Labels represent
        <em>device_id.sensor_id</em>
    </div>

</body>

</html>